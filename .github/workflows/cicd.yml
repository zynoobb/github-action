name: githubaction-cd

on:
  push:
    branches: [ "master" ]

jobs:
  cd:
    name : gitaction-cd
    runs-on: ubuntu-latest

    steps:
    - name : checkout
      uses: actions/checkout@v3

    - id : "auth"
      name : Authenticate to GCP
      uses : google-github-actions/auth@v0
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
    
    - name : server-on
      run : |-
        gcloud compute ssh --project=${{ secrets.GCP_PROJECT_ID }} --zone=${{ secrets.GCP_ZONE }} ${{ secrets.GCP_VM_NAME }}@${{ secrets.GCP_VM_NAME2 }} \
        --command "ls" \
        --command "cd github-action" \
        --command "ls" \
        --command "docker-compose stop" \
        --command "docker image prune -a" \
        --command "git pull" \
        --command "docker-compose -f docker-compose.prod.yaml build" \
        --command "docker-compose -f docker-compose.prod.yaml up -d" \